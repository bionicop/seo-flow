# AI Assistant Rules for seo-flow

## Code Standards

### Type Hints
- All function parameters must have type hints
- All return types must be annotated
- Use `Optional[T]` for nullable types
- Use `list[T]` not `List[T]` (Python 3.9+)

### Docstrings
- Use Google-style docstrings for all public functions/classes
- Include Args, Returns, Raises sections
- Add usage examples for complex functions

### Formatting
- Line length: 88 characters (Black default)
- Use double quotes for strings
- Sort imports with isort (profile=black)

## Architecture Rules

### Collectors
- All collectors inherit from `BaseCollector`
- Each collector implements `collect(query: str) -> CollectorResponse`
- Handle rate limiting internally with exponential backoff
- Return structured `CollectorResponse` even on failure

### Analyzers
- Input: pandas DataFrame or dict
- Output: `AnalysisResult` Pydantic model
- Handle edge cases (empty data, single point, NaN)
- Never raise exceptions - return error in response

### AI Integration
- Use Pydantic models for structured output
- Include retry logic for API failures
- Truncate input if token limit approached
- Always return valid JSON structure

### Reporters
- Use Jinja2 templates for generation
- Sanitize all user input before rendering
- Support both Markdown and HTML output

## Error Handling

### Custom Exceptions
```python
class SEOFlowError(Exception):
    """Base exception for seo-flow"""

class CollectorError(SEOFlowError):
    """Data collection failed"""

class AnalysisError(SEOFlowError):
    """Analysis processing failed"""

class AIError(SEOFlowError):
    """AI generation failed"""
```

### Response Pattern
All operations return structured responses:
```python
{
    "success": bool,
    "data": Any | None,
    "error": str | None,
    "metadata": {
        "timestamp": str,
        "source": str,
        "duration_ms": int
    }
}
```

## Configuration

### Environment Variables
- All secrets via `.env` file
- Use `pydantic-settings` for validation
- Provide sensible defaults where safe
- Never log or print secrets

### Required ENV Variables
```
SERPER_API_KEY       # Required for Serper collector
GEMINI_API_KEY       # Required for AI insights
GSC_CREDENTIALS_PATH # Optional for GSC collector
```

## Testing

### Requirements
- Minimum 80% coverage for `src/`
- Mock all external API calls
- Use pytest fixtures for shared data
- Test all edge cases documented in plan

### Test Structure
```
tests/
├── conftest.py          # Shared fixtures
├── unit/
│   ├── test_collectors.py
│   ├── test_analyzers.py
│   └── test_ai.py
└── integration/
    └── test_pipeline.py
```

## Git Commits

### Format
```
<type>(<scope>): <description>

[optional body]
```

### Types
- `init`: Project initialization
- `feat`: New feature
- `fix`: Bug fix
- `docs`: Documentation
- `test`: Tests
- `refactor`: Code refactoring

### Examples
```
init: project structure and config
feat(collectors): add Serper API integration
fix(analyzers): handle division by zero in CTR
docs: update README with setup instructions
```
